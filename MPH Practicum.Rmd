---
title: "MPH Practicum"
output: pdf_document
---

```{r packages, include = F}
#load packages at the beginning of each session
library(tidyverse)
library(lubridate)
library(kableExtra)
library(janitor)
library(readxl)
library(writexl)
library(lmtest)
library(broom)
library(pscl)
library(flexmix)
library(pROC)
library(ggplot2)
```

```{r load file, include = F}
#import VA biomarker data from REDCap
biomarkers <- readr::read_csv("./data/MasterDatabaseLiaoLa-VABiomarkersForBladd_DATA_2022-05-11_1411.csv")

#import clean va detection data
va <- read_xlsx("./data/VA_Detection.xlsx")
```

```{r data cleaning, include = F}
#split biomarker data into pt data and sample data
pt_hx <- biomarkers %>%
  filter(study_site == 1) %>%
  select(record_id, smoke_quit, smoke_packs) %>%
  rename(id = record_id)

va_clean <- va %>%
  rename(id = pt) %>%
  #sort by id and date
  arrange(id, desc(date)) %>%
  #remove duplicate ids
  distinct(id, .keep_all = T)

detection <- merge(x = va_clean, y = pt_hx, by="id", all.x = T) %>%
  #add indicator variable for smoke_packs
  mutate(packyrs = if_else(is.na(smoke_packs), 0, 1)) %>%
  #add indicator variable for smoke_quit
  mutate(yearquit = if_else(is.na(smoke_quit), 0, 1)) %>%
  #add indicator variable for bladder cancer
  mutate(bca = if_else(risk == "NoBC", 0, 1)) %>%
  #add indicator variable for smoker (current + former)
  mutate(smoker = if_else(smoking == "never", 0, 1))

#make smoking a factor
detection$smoking <- factor(detection$smoking, levels = c("never", "former", "current"))

#make risk a factor
detection$risk <- factor(detection$risk, levels = c("NoBC", "low", "intermediate", "high"))
```

```{r descriptive data, echo = F}
smoking_count <- detection %>%
  group_by(smoking, smoker) %>%
  count(smoking, smoker)
  
cysto_result_risk <- detection %>%
  group_by(visual_suspicion, risk, bca) %>%
  count(visual_suspicion, risk, bca)

smoking_hx <- detection %>%
  group_by(smoking, packyrs, yearquit) %>%
  count(smoking, packyrs, yearquit)
```

```{r demographics table, echo = F}

```

```{r exclusion table, echo = F}
exclusion <- data.frame(Criteria = c("Initial", "UTUC", "No cysto", "No follow up", "Insufficient RNA for biomarker analysis", "Duplicates", "Total"),
                        n = c("184", "5","1", "4", "7", "9", "158")
                        )

kable(exclusion,
      booktabs = T,
      align = "lr",
      caption = "Exclusion criteria",
      col.names = c("", "n")
      ) %>%
  pack_rows(index = c(" " = 1, "Excluded" = 5)) %>%
  row_spec(1, bold = T) %>%
  row_spec(7, bold = T)
```

```{r figures, echo = F}
kable(smoking_count,
      booktabs = T,
      align = "l",
      caption = "Smoking count"
      )

kable(cysto_result_risk,
      booktabs = T,
      align = "l",
      caption = "Cysto results vs risk"
      )

kable(smoking_hx,
      booktabs = T,
      align = "l",
      caption = "Smoking history"
      )
```

\newpage

```{r log models}
#logistic regression cancer = biomarkers
log_biomarkers <- glm(bca ~ ROBO1 + CRH + IGF2, family = "binomial", data = detection)
summary(log_biomarkers)

#logistic regression cancer = model3
log_model3 <- glm(bca ~ MODEL3, family = "binomial", data = detection)
summary(log_model3)

#logistic regression cancer = biomarkers + smoking(binary)
log_smoker <- glm(bca ~ ROBO1 + CRH + IGF2 + smoker, family = "binomial", data = detection)
summary(log_smoker)

#logistic regression cancer = biomarkers + smoking(factor)
log_smoking <- glm(bca ~ ROBO1 + CRH + IGF2 + smoking, family = "binomial", data = detection)
summary(log_smoking)
```

```{r r squared}
#R-squared cancer = biomarkers
pR2(log_biomarkers)['McFadden']

#R-squared cancer = model3
pR2(log_model3)['McFadden']

#R-squared cancer = biomarkers + smoking(binary)
pR2(log_smoker)['McFadden']

#R-squared cancer = biomarkers + smoking(factor)
pR2(log_smoking)['McFadden']
```

```{r c statistics}
#c statistics cancer = biomarkers
predictions_biomarkers <- predict(log_biomarkers, type = "response")
roc(detection$bca, predictions_biomarkers)

#c statistics cancer = model3
predictions_model3 <- predict(log_model3, type = "response")
roc(detection$bca, predictions_model3)

#c statistics cancer = biomarkers + smoking(binary)
predictions_smoker <- predict(log_smoker, type = "response")
roc(detection$bca, predictions_smoker)

#c statistics cancer = biomarkers + smoking(factor)
predictions_smoking <- predict(log_smoking, type = "response")
roc(detection$bca, predictions_smoking)
```

```{r BIC}
#BIC cancer = biomarkers
BIC(log_biomarkers)

#BIC cancer = model3
BIC(log_model3)

#BIC cancer = biomarkers + smoking(binary)
BIC(log_smoker)

#BIC cancer = biomarkers + smoking(factor)
BIC(log_smoking)
```

```{r ROC curves}
#ROC cancer = biomarkers
ggroc(roc(detection$bca, predictions_biomarkers)) +
  theme_minimal() + 
  ggtitle("ROC log_biomarkers") + 
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")

#ROC cancer = model3
ggroc(roc(detection$bca, predictions_model3)) +
  theme_minimal() + 
  ggtitle("ROC log_model3") + 
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")

#ROC cancer = biomarkers + smoking(binary)
ggroc(roc(detection$bca, predictions_smoker)) +
  theme_minimal() + 
  ggtitle("ROC log_smoker") + 
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")

#ROC cancer = biomarkers + smoking(factor)
ggroc(roc(detection$bca, predictions_smoking)) +
  theme_minimal() + 
  ggtitle("ROC log_smoking") + 
  geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color="grey", linetype="dashed")
```

```{r export data, include = F}
write_xlsx(detection, "./data/detection.xlsx")
```